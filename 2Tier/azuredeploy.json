{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "defaultValue": "[resourceGroup().location]",
            "type": "string"
        },
        "sapSystemId": {
            "type": "string",
            "defaultValue": "TST"
        },
        "osType": {
            "type": "string",
            "allowedValues": [
                    "SLES for SAP 12 SP3",
                    "SLES for SAP 12 SP4",
                    "SLES for SAP 15",
                    "SLES for SAP 15 SP1"
                ],
            "defaultValue": "SLES for SAP 12 SP4",
            "metadata": {
                "description": "The type of the operating system you want to deploy."
            }
        },
        "size": {
            "type": "string",
            "allowedValues": [
                "Demo",
                "Small",
                "Medium",
                "Large"
            ],
            "defaultValue": "Demo",
            "metadata": {
                "description": "The type of the operating system you want to deploy."
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for the Virtual Machine."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "Password for the Virtual Machine."
            }
        },
        "sshKeyData": {
            "type": "string",
            "defaultValue": ""
        },
        "createVNET": {
            "type": "bool",
            "defaultValue": true
        },
        "vnetResourceGroup": {
            "defaultValue": "[resourceGroup().name]",
            "type": "string"
        },        
        "addressPrefixes": {
            "defaultValue": "10.0.0.0/24",
            "type": "array"
        },
        "subnetName": {
            "defaultValue": "subnet",
            "type": "string"
        },
        "subnetPrefix": {
            "defaultValue": "10.0.0.0/24",
            "type": "string"
        },
        "nsgName": {
            "defaultValue": "nsg",
            "type": "string"
        },
        "vnetName": {
            "defaultValue": "vnet",
            "type": "string"
        },
        "hPIPName": {
            "defaultValue": "hana-pip",
            "type": "string"
        },
        "hNICName": {
            "defaultValue": "hana-nic",
            "type": "string"
        },
        "hVMName": {
            "defaultValue": "hana-vm",
            "type": "string"
        },
        "hanaVMSize": {
            "defaultValue": "Standard_E4s_v3",
            "type": "string"
        },
        "_SUSETags": {
            "type": "object",
            "defaultValue": {
                "provider": "b0d27bab-bf43-4cad-9bf5-40a8041d59b8"
            }
        }
       
    },
    "variables": {
        "sshKeyPath": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
        
        "sshKeysArrayKey": [
            {
                "path": "[variables('sshKeyPath')]",
                "keyData": "[parameters('sshKeyData')]"
            }
        ],
        "imageSku" :  "[if(equals(parameters('osType'), 'SLES for SAP 15 SP1'), 'gen1', if(equals(parameters('osType'), 'SLES for SAP 15'), '15', if(equals(parameters('osType'), 'SLES for SAP 12 SP4'), '12-SP4', if(equals(parameters('osType'), 'SLES for SAP 12 SP3'), '12-SP3', '12-SP4'))))]",
        "imageOffer" : "[if(equals(parameters('osType'), 'SLES for SAP 15 SP1'), 'sles-sap-15-sp1', 'SLES-SAP')]",
        "sshKeysArrayEmpty": [],
        "sshKeysArray": "[if(equals(length(parameters('sshKeyData')), 0), variables('sshKeysArrayEmpty'), variables('sshKeysArrayKey'))]",
        "internalSubnetId": "[resourceId(parameters('vnetResourceGroup'),'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]",
         "sizes": {
            "Demo": {
                "hana": {
                    "vmSize": "[parameters('hanaVMSize')]",
                    "disks": [
                        {
                            "lun": 0,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 1,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 2,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 3,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 4,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 5,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 6,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        },
                        {
                            "lun": 7,
                            "createOption": "Empty",
                            "diskSizeGB": 128
                        }
                    ],
                    "scriptArguments": "[concat('-luns \"0,1#2,3#4#5#6#7\" -names \"data#log#shared#usrsap#backup#sapmnt\" -paths \"/hana/data#/hana/log#/hana/shared#/usr/sap#/hana/backup#/sapmnt/', parameters('sapSystemId'), '\" -sizes \"100#100#100#100#100#100\"')]",
                    "useFastNetwork": false
                }
            },
            "Small": {
                "hana": {
                    "vmSize": "[parameters('hanaVMSize')]",
                    "disks": [
                        {
                            "lun": 0,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 1,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 2,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 3,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 4,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 64
                        },
                        {
                            "lun": 5,
                            "caching": "None",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 6,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 64
                        }
                    ],
                    "scriptArguments": "[concat('-luns \"0,1,2#3#4#5#6\" -names \"datalog#shared#usrsap#backup#sapmnt\" -paths \"/hana/data,/hana/log#/hana/shared#/usr/sap#/hana/backup#/sapmnt/', parameters('sapSystemId'), '\" -sizes \"70,100#100#100#100#100\"')]",
                    "useFastNetwork": true
                }
            },
            "Medium": {
                "hana": {
                    "vmSize": "[parameters('hanaVMSize')]",
                    "disks": [
                        {
                            "lun": 0,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 1,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 2,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 3,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 4,
                            "caching": "None",
                            "writeAcceleratorEnabled": "true",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 5,
                            "caching": "None",
                            "writeAcceleratorEnabled": "true",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 6,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 7,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 64
                        },
                        {
                            "lun": 8,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 9,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 10,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 64
                        }
                    ],
                    "scriptArguments": "[concat('-luns \"0,1,2,3#4,5#6#7#8,9#10\" -names \"data#log#shared#usrsap#backup#sapmnt\" -paths \"/hana/data#/hana/log#/hana/shared#/usr/sap#/hana/backup#/sapmnt/', parameters('sapSystemId'), '\" -sizes \"100#100#100#100#100#100\"')]",
                    "useFastNetwork": true
                }
            },
            "Large": {
                "hana": {
                    "vmSize": "[parameters('hanaVMSize')]",
                    "disks": [
                        {
                            "lun": 0,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 1,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 2,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },                        
                        {
                            "lun": 3,
                            "caching": "None",
                            "writeAcceleratorEnabled": "true",
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 4,
                            "caching": "None",
                            "writeAcceleratorEnabled": "true",  
                            "createOption": "Empty",
                            "diskSizeGB": 512
                        },
                        {
                            "lun": 5,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 1024
                        },
                        {
                            "lun": 6,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 64
                        },
                        {
                            "lun": 7,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 2048
                        },
                        {
                            "lun": 8,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 2048
                        },
                        {
                            "lun": 9,
                            "caching": "ReadOnly",
                            "createOption": "Empty",
                            "diskSizeGB": 64
                        }
                    ],
                    "scriptArguments": "[concat('-luns \"0,1,2#3,4#5#6#7,8#9\" -names \"data#log#shared#usrsap#backup#sapmnt\" -paths \"/hana/data#/hana/log#/hana/shared#/usr/sap#/hana/backup#/sapmnt/', parameters('sapSystemId'), '\" -sizes \"100#100#100#100#100#100\"')]",
                    "useFastNetwork": true
                }
            }
        },
        "hOSDiskCaching": "ReadWrite",
        "hOSDiskStorageType": "Premium_LRS"
    },
    "resources": [
        {
            "apiVersion": "2018-05-01",
            "name": "pid-01afcbdc-d715-44d9-b145-b0be90d9dff5",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.managment.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[concat(parameters('nsgName'))]",
            "apiVersion": "2018-04-01",
            "location": "[parameters('location')]",
            "condition": "[parameters('createVNET')]",
            "tags": {
                "provider": "[toUpper(parameters('_SUSETags').provider)]"
            },
            "properties": {
                "securityRules": [
                    {
                        "name": "SSH",
                        "properties": {
                            "description": "Allow SSH Subnet",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "22",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[parameters('vnetName')]",
            "apiVersion": "2018-04-01",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkSecurityGroups/', parameters('nsgName'))]"
            ],
            "condition": "[parameters('createVNET')]",
            "tags": {
                "provider": "[toUpper(parameters('_SUSETags').provider)]"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": "[parameters('addressPrefixes')]"
                },
                "subnets": [
                    {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('subnetPrefix')]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[parameters('hPIPName')]",
            "apiVersion": "2018-04-01",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]"
            ],
            "location": "[parameters('location')]",
            "condition": "[parameters('createVNET')]",
            "tags": {
                "provider": "[toUpper(parameters('_SUSETags').provider)]"
            },
            "properties": {
                "publicIPAllocationMethod": "Dynamic"
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[parameters('hNICName')]",
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]",
                "[concat('Microsoft.Network/publicIPAddresses/', parameters('hPIPName'))]"
            ],
            "location": "[parameters('location')]",
            "tags": {
                "provider": "[toUpper(parameters('_SUSETags').provider)]"
            },
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": "[if(parameters('createVNET'), json(concat('{\"id\": \"', resourceId('Microsoft.Network/publicIPAddresses', parameters('hPIPName')), '\"}')), json('null'))]",
                            "subnet": {
                                "id": "[variables('internalSubnetId')]"
                            }
                        }
                    }
                ],
                "enableAcceleratedNetworking": "[variables('sizes')[parameters('size')].hana.useFastNetwork]"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[parameters('hVMName')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', parameters('hNICName'))]"
            ],
            "apiVersion": "2018-06-01",
            "location": "[parameters('location')]",
            "tags": {
                "provider": "[toUpper(parameters('_SUSETags').provider)]"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('sizes')[parameters('size')].hana.vmSize]"
                },
                "osProfile": {
                    "computerName": "[parameters('hVMName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": "[if(equals(length(parameters('sshKeyData')), 0), bool('false'), bool('true'))]",
                        "ssh": {
                            "publicKeys": "[variables('sshKeysArray')]"
                        }
                    },
                    "customData": "IyEvYmluL2Jhc2gKZXhlYyAzPiYxIDQ+JjIKdHJhcCAnZXhlYyAyPiY0IDE+JjMnIDAgMSAyIDMKZXhlYyAxPi92YXIvbG9nL3RlbXBsYXRlX2RlYnVnLm91dCAyPiYxCiMgRXZlcnl0aGluZyBiZWxvdyB3aWxsIGdvIHRvIHRoZSBmaWxlICdsb2cub3V0JzoKCiMKIyMgY3JlYXRlIGFsbCBoYW5hIHBhcnRpdGlvbnMgZGVwZW5kaW5nIG9uIGlucHV0IHBhcmFtZXRlciBmcm9tIEFSTSB0ZW1wbGF0ZQojCgpmdW5jdGlvbiBsb2coKQp7CiAgbWVzc2FnZT0kQAogIGVjaG8gIiRtZXNzYWdlIgogIGVjaG8gIiQoZGF0ZSAtSXNlY29uZHMpOiAkbWVzc2FnZSIgPj4gL3Zhci9sb2cvc2FwY29uZmlnY3JlYXRlCiAgZWNobyAiJChkYXRlIC1Jc2Vjb25kcyk6ICRtZXNzYWdlIiA+PiAvdG1wL3NhcGNvbmZpZ2NyZWF0ZQp9CgpmdW5jdGlvbiBhZGR0b2ZzdGFiKCkKewogIGxvZyAiICAgIC0+YWRkdG9mc3RhYiIKICBwYXJ0UGF0aD0kMQogIG1vdW50PSQyCiAgCiAgbG9jYWwgYmxraWQ9JCgvc2Jpbi9ibGtpZCAkcGFydFBhdGgpCiAgbG9nICIgICAgVXNpbmcgYmxraWQ6ICRibGtpZCIKCiAgaWYgW1sgJGJsa2lkID1+ICBVVUlEPVwiKC57MzZ9KVwiIF1dCiAgdGhlbgogICAgbG9nICIgICAgQWRkaW5nIGZzdGFiIGVudHJ5IHdpdGggVVVJRCIKICAgIGxvY2FsIHV1aWQ9JHtCQVNIX1JFTUFUQ0hbMV19OwogICAgbG9jYWwgbW91bnRDbWQ9IiIKICAgIG1vdW50Q21kPSIvZGV2L2Rpc2svYnktdXVpZC8kdXVpZCAkbW91bnQgeGZzICBkZWZhdWx0cyxub2ZhaWwgIDAgIDIiCiAgICBlY2hvICIkbW91bnRDbWQiID4+IC9ldGMvZnN0YWIKICAgICQobW91bnQgJHBhcnRQYXRoICRtb3VudCkKICBlbHNlCiAgICBsb2cgIiAgICBFUlI6IG5vIFVVSUQgZm91bmQiCiAgICBleGl0IC0xOwogIGZpCiAgCiAgbG9nICIgICAgLT5hZGR0b2ZzdGFiIGRvbmUiCn0KCmZ1bmN0aW9uIGdldGRldmljZXBhdGgoKQp7CiAgIyBBenVyZSBkb2VzIGNyZWF0ZSBhbiBhZGRpdGlvbmFsIGVudHJ5IGJlbG93IC9kZXYvZGlzay8KICAjIHdoaWNoIGxpbmtzIHRvIHRoZSAKICAjIC9kZXYvZGlzay9henVyZSAKICAjICAgL2Rldi9kaXNrL2F6dXJlL3Jvb3QKICAjICAgL2Rldi9kaXNrL2F6dXJlL3Jlc291cmNlCiAgIyAgIC9kZXYvZGlzay9henVyZS9zY3NpMSAgCiAgIyAgICAgL2Rldi9kaXNrL2F6dXJlL3Njc2kxL2x1bjAKICAjIC9kZXYvZGlzay9ieS1pZCAgCiAgIyAvZGV2L2Rpc2svYnktbGFiZWwKICAjIC9kZXYvZGlzay9ieS1wYXRoCiAgIyAvZGV2L2Rpc2svYnktdXVpZAoKICBsb2cgIiAgIC0+Z2V0ZGV2aWNlcGF0aCIKCiAgZ2V0ZGV2aWNlcGF0aHJlc3VsdD0iIgogIGxvY2FsIGx1bj0kMQogIGxvY2FsIHJlYWRsaW5rT3V0cHV0PSQocmVhZGxpbmsgL2Rldi9kaXNrL2F6dXJlL3Njc2kxL2x1biRsdW4pCiAgbG9jYWwgc2NzaU91dHB1dD0kKGxzc2NzaSkKICBpZiBbWyAkcmVhZGxpbmtPdXRwdXQgPX4gKHNkW2EtekEtWl17MSwyfSkgXV07CiAgdGhlbgogICAgbG9nICIgICAgIGZvdW5kIGRldmljZSBwYXRoIHVzaW5nIHJlYWRsaW5rIgogICAgZ2V0ZGV2aWNlcGF0aHJlc3VsdD0iL2Rldi8ke0JBU0hfUkVNQVRDSFsxXX0iOwogIGVsaWYgW1sgJHNjc2lPdXRwdXQgPX4gXFs1OjA6MDokbHVuXF1bXlxbXSooL2Rldi9zZFthLXpBLVpdezEsMn0pIF1dOwogIHRoZW4KICAgIGxvZyAiICAgICBmb3VuZCBkZXZpY2UgcGF0aCB1c2luZyBsc3Njc2kiCiAgICBnZXRkZXZpY2VwYXRocmVzdWx0PSR7QkFTSF9SRU1BVENIWzFdfTsKICBlbHNlCiAgICBsb2cgIiAgICBFUlI6IDpsc3Njc2kgb3V0cHV0IG5vdCBhcyBleHBlY3RlZCBmb3IgJGx1biIKICAgIGV4aXQgLTE7CiAgZmkKICBsb2cgIiAgIC0+Z2V0ZGV2aWNlcGF0aCBkb25lIgp9CgpmdW5jdGlvbiBjcmVhdGVsdm0oKQp7CiAgbG9nICJjcmVhdGVsdm0iCgogIGxvY2FsIGx1bnNBPSgkezEvLywvIH0pCiAgbG9jYWwgdmdOYW1lPSQyCiAgbG9jYWwgbHZOYW1lPSQzCgogIGxvY2FsIGx1bnNDb3VudD0keyNsdW5zQVtAXX0KCiAgbG9jYWwgbW91bnRQYXRoQT0oJHs0Ly8sLyB9KQogIGxvY2FsIHNpemVBPSgkezUvLywvIH0pCgogIGxvY2FsIG1vdW50UGF0aENvdW50PSR7I21vdW50UGF0aEFbQF19CiAgbG9jYWwgc2l6ZUNvdW50PSR7I3NpemVBW0BdfQoKICBsb2cgIiBjb3VudCAkbHVuc0NvdW50ICRtb3VudFBhdGhDb3VudCAkc2l6ZUNvdW50IgoKICBpZiBbWyAkbHVuc0NvdW50IC1ndCAxIF1dCiAgdGhlbgogICAgbG9nICItPmNyZWF0aW5nIGx2bSBkZXZpY2VzIgoKICAgIGxvY2FsIG51bVJhaWREZXZpY2VzPTAKICAgIGxvY2FsIHJhaWREZXZpY2VzPSIiCiAgICBsb2cgIiAgIG51bSBsdW5zICRsdW5zQ291bnQiCiAgICAKICAgIGZvciAoKGk9MDsgaTxsdW5zQ291bnQ7IGkrKykpCiAgICBkbwogICAgICBsb2cgIiAgIHRyeWluZyB0byBmaW5kIGRldmljZSBwYXRoIgogICAgICBsb2NhbCBsdW49JHtsdW5zQVskaV19CiAgICAgIGdldGRldmljZXBhdGggJGx1bgogICAgICBsb2NhbCBkZXZpY2VQYXRoPSRnZXRkZXZpY2VwYXRocmVzdWx0OwogICAgICAKICAgICAgaWYgWyAtbiAiJGRldmljZVBhdGgiIF07CiAgICAgIHRoZW4KICAgICAgICBsb2cgIiAgIERldmljZSBQYXRoIGlzICRkZXZpY2VQYXRoIgogICAgICAgIG51bVJhaWREZXZpY2VzPSQoKG51bVJhaWREZXZpY2VzICsgMSkpCiAgICAgICAgcmFpZERldmljZXM9IiRyYWlkRGV2aWNlcyAkZGV2aWNlUGF0aCAiCiAgICAgIGVsc2UKICAgICAgICBsb2cgIiAgIG5vIGRldmljZSBwYXRoIGZvciBMVU4gJGx1biIKICAgICAgICBleGl0IC0xOwogICAgICBmaQogICAgZG9uZQoKICAgIGxvZyAiICAgbnVtOiAkbnVtUmFpZERldmljZXMgcGF0aHM6ICckcmFpZERldmljZXMnIgogICAgcHZjcmVhdGUgJHJhaWREZXZpY2VzCiAgICBsb2cgIiAgIHB2Y3JlYXRlIGRvbmUiCiAgICB2Z2NyZWF0ZSAkdmdOYW1lICRyYWlkRGV2aWNlcwogICAgbG9nICIgICB2Z2NyZWF0ZSBkb25lIgoKICAgIGZvciAoKGo9MDsgajxtb3VudFBhdGhDb3VudDsgaisrKSkKICAgIGRvCiAgICAgIGxvY2FsIG1vdW50UGF0aExvYz0ke21vdW50UGF0aEFbJGpdfQogICAgICBsb2NhbCBzaXplTG9jPSR7c2l6ZUFbJGpdfQogICAgICBsb2NhbCBsdk5hbWVMb2M9IiRsdk5hbWUtJGoiCiAgICAgIGx2Y3JlYXRlIC0tZXh0ZW50cyAkc2l6ZUxvYyVGUkVFIC0tc3RyaXBlcyAkbnVtUmFpZERldmljZXMgLS1uYW1lICRsdk5hbWVMb2MgJHZnTmFtZQogICAgICBsb2cgIiAgIGx2Y3JlYXRlIGRvbmUiCgogICAgICBta2ZzIC10IHhmcyAvZGV2LyR2Z05hbWUvJGx2TmFtZUxvYwogICAgICBsb2cgIiAgIG1reGZzIGRvbmUiCiAgICAgIAogICAgICBta2RpciAtcCAkbW91bnRQYXRoTG9jCiAgICAgIGxvZyAiICAgbW91bnRwb2ludCBjcmVhdGUgZG9uZSIKICAgIAogICAgICBhZGR0b2ZzdGFiIC9kZXYvJHZnTmFtZS8kbHZOYW1lTG9jICRtb3VudFBhdGhMb2MKICAgIGRvbmUKCiAgZWxzZQogICAgbG9nICItPmNyZWF0aW5nIHNpbmdsZSBkaXNrIgoKICAgIGxvY2FsIGx1bj0ke2x1bnNBWzBdfQogICAgbG9jYWwgbW91bnRQYXRoTG9jPSR7bW91bnRQYXRoQVswXX0KCiAgICBnZXRkZXZpY2VwYXRoICRsdW47CiAgICBsb2NhbCBkZXZpY2VQYXRoPSRnZXRkZXZpY2VwYXRocmVzdWx0OwogICAgCiAgICBpZiBbIC1uICIkZGV2aWNlUGF0aCIgXTsKICAgIHRoZW4KICAgICAgbG9nICIgICBEZXZpY2UgUGF0aCBpcyAkZGV2aWNlUGF0aCIKICAgICAgIyBodHRwOi8vc3VwZXJ1c2VyLmNvbS9xdWVzdGlvbnMvMzMyMjUyL2NyZWF0aW5nLWFuZC1mb3JtYXRpbmctYS1wYXJ0aXRpb24tdXNpbmctYS1iYXNoLXNjcmlwdAogICAgICAjIG4gLSBhZGQgYSBuZXcgcGFydGl0b24KICAgICAgIyBwIC0gcHJpbWFyeSBwYXJ0aXRpb24KICAgICAgIyAxIC0gcGFydGl0aW9uIG51bWJlciAxCiAgICAgICMgUkVUVVJOIC0gYWNjZXB0IGZpcnN0IHNlY3RvcgogICAgICAjIFJFVFVSTiAtIGFjY2VwdCBsc3Qgc2VjdG9yCiAgICAgICMgd3JpdGUgdGFibGUgdG8gZGlzawogICAgICAkKGVjaG8gLWUgIm5cbnBcbjFcblxuXG53IiB8IGZkaXNrICRkZXZpY2VQYXRoKQogICAgICBzeW5jCiAgICAgIGxvZyAiICAgcGFydGl0aW9uaW5nIGNyZWF0ZSBkb25lIgoKICAgICAgbG9jYWwgcGFydFBhdGg9IiRkZXZpY2VQYXRoIiIxIgogICAgICBsb2cgIiAgIHBhcnRpb246ICRwYXJ0UGF0aCIKCiAgICAgIG1rZnMgLXQgeGZzICRwYXJ0UGF0aAogICAgICBsb2cgIiAgIG1reGZzIGRvbmUiCgogICAgICBta2RpciAtcCAkbW91bnRQYXRoTG9jCiAgICAgIGxvZyAiICAgbW91bnRwb2ludCBjcmVhdGUgZG9uZSIKCiAgICAgIGFkZHRvZnN0YWIgJHBhcnRQYXRoICRtb3VudFBhdGhMb2MKICAgIGVsc2UKICAgICAgbG9nICIgICBFUlI6IG5vIGRldmljZSBwYXRoIGZvciBMVU4gJGx1biIKICAgICAgZXhpdCAtMTsKICAgIGZpCiAgZmkKCiAgbG9nICJjcmVhdGVsdm0gZG9uZSIKfQoKZnVuY3Rpb24gaW5zdGFsbFBhY2thZ2VzKCkKewogICBsb2cgImluc3RhbGxQYWNrYWdlcyBzdGFydCIKCiAgICMgdXBkYXRlIGV2ZXJ5dGhpbmcKICAgenlwcGVyIHBhdGNoIC15CiAgICMgaW5zdGFsbCBwYXR0ZXJuCiAgIHp5cHBlciBpbnN0YWxsIC15IC10IHBhdHRlcm4gc2FwLWhhbmEKICAgI2luc3RhbGwgcGFja2FnZXMKICAgenlwcGVyIGluc3RhbGwgLXkgc2FwdHVuZQogICAKICAgbG9nICJpbnN0YWxsUGFja2FnZXMgZG9uZSIKfQoKZnVuY3Rpb24gZW5hYmxlU3dhcCgpCnsKICBsb2cgImVuYWJsZVN3YXAgc3RhcnQiCiAgCiAgc2VkIC1pLmJhayAicy9SZXNvdXJjZURpc2suRW5hYmxlU3dhcD1uL1Jlc291cmNlRGlzay5FbmFibGVTd2FwPXkvIiAvZXRjL3dhYWdlbnQuY29uZiAKICBzZWQgLWkuYmFrICJzL1Jlc291cmNlRGlzay5Td2FwU2l6ZU1CPTAvUmVzb3VyY2VEaXNrLlN3YXBTaXplTUI9MjA0OC8iIC9ldGMvd2FhZ2VudC5jb25mCiAgCiAgI3NlcnZpY2Ugd2FhZ2VudCByZXN0YXJ0CgogIGxvZyAiZW5hYmxlU3dhcCBkb25lIgogIAp9CgojIyMjIyMjIyMjIyMjIyMjCiMgIyMjIE1BSU4gIyMjICMKIyMjIyMjIyMjIyMjIyMjIwpsb2cgJEAKCiMgZXhhbXBsZSBpbnB1dCAKIwojICAtbHVucyAiMCwxIzIsMyM0IzUjNiM3IgojICAtbmFtZXMgImRhdGEjbG9nI3NoYXJlZCN1c3JzYXAjYmFja3VwI3NhcG1udCIKIyAgLXBhdGhzICIvaGFuYS9kYXRhIy9oYW5hL2xvZyMvaGFuYS9zaGFyZWQjL3Vzci9zYXAjL2hhbmEvYmFja3VwIy9zYXBtbnQvQUJDIgojICAtc2l6ZXMgIjEwMCMxMDAjMTAwIzEwMCMxMDAjMTAwIgojCmx1bnM9IiIKbmFtZXM9IiIKcGF0aHM9IiIKc2l6ZXM9IiIKCm51bXBhcmE9MAoKaWYgWyAkIyAtZXEgMCBdCnRoZW4KICBlY2hvICJObyBwYXJhbWV0ZXJzIHByb3ZpZGVkIjsKICBleGl0IDI7CmZpCgp3aGlsZSBbICQjICE9IDAgXTsKZG8KICBjYXNlICIkMSIgaW4KICAgICItbHVucyIpICBsdW5zPSQyO3NoaWZ0IDI7bG9nICIgZm91bmQgbHVucyIKICAgIDs7CiAgICAiLW5hbWVzIikgIG5hbWVzPSQyO3NoaWZ0IDI7bG9nICIgZm91bmQgbmFtZXMiCiAgICA7OwogICAgIi1wYXRocyIpICBwYXRocz0kMjtzaGlmdCAyO2xvZyAiIGZvdW5kIHBhdGhzIgogICAgOzsKICAgICItc2l6ZXMiKSAgc2l6ZXM9JDI7c2hpZnQgMjtsb2cgIiBmb3VuZCBzaXplcyIKICAgIDs7CiAgICAqKSBsb2cgIkVSUjp1bmtub3duIHBhcmFtZXRlciAkMSI7c2hpZnQgMTsgbnVtcGFyYT0xCiAgICA7OwogIGVzYWMKZG9uZQoKaWYgWyAkbnVtcGFyYSAtbmUgMCBdCnRoZW4KICBlY2hvICJXcm9uZyBwYXJhbWV0ZXJzIHByb3ZpZGVkIjsKICBleGl0IDI7CgpmaQoKbG9nICIgcnVubmluZyB3aXRoICRsdW5zICRuYW1lcyAkcGF0aHMgJHNpemVzIiAKCmx1bnNTcGxpdD0oJHtsdW5zLy8jLyB9KQpuYW1lc1NwbGl0PSgke25hbWVzLy8jLyB9KQpwYXRoc1NwbGl0PSgke3BhdGhzLy8jLyB9KQpzaXplc1NwbGl0PSgke3NpemVzLy8jLyB9KQoKbHVuc0NvdW50PSR7I2x1bnNTcGxpdFtAXX0KbmFtZXNDb3VudD0keyNuYW1lc1NwbGl0W0BdfQpwYXRoc0NvdW50PSR7I3BhdGhzU3BsaXRbQF19CnNpemVzQ291bnQ9JHsjc2l6ZXNTcGxpdFtAXX0KCmxvZyAiIGNvdW50ICRsdW5zQ291bnQgJG5hbWVzQ291bnQgJHBhdGhzQ291bnQgJHNpemVzQ291bnQiCgppZiBbWyAkbHVuc0NvdW50IC1lcSAkbmFtZXNDb3VudCAmJiAkbmFtZXNDb3VudCAtZXEgJHBhdGhzQ291bnQgJiYgJHBhdGhzQ291bnQgLWVxICRzaXplc0NvdW50IF1dCnRoZW4KICBmb3IgKChpcGFydD0wOyBpcGFydDxsdW5zQ291bnQ7IGlwYXJ0KyspKQogIGRvCiAgICBsdW49JHtsdW5zU3BsaXRbJGlwYXJ0XX0KICAgIG5hbWU9JHtuYW1lc1NwbGl0WyRpcGFydF19CiAgICBwYXRoPSR7cGF0aHNTcGxpdFskaXBhcnRdfQogICAgc2l6ZT0ke3NpemVzU3BsaXRbJGlwYXJ0XX0KICAgIGxvZyAiPXN0YXJ0IExVTiAkbHVuID09PT09PT09PT09PT09IgogICAgbG9nICJjcmVhdGluZyBkaXNrIHdpdGggTFVOOiAkbHVuIFZHOiAkbmFtZSBQQVRIOiAkcGF0aCBTSVpFOiAkc2l6ZSIKICAgIGNyZWF0ZWx2bSAkbHVuICJ2Zy0kbmFtZSIgImx2LSRuYW1lIiAiJHBhdGgiICIkc2l6ZSI7CiAgICBsb2cgIj1lbmQgTFVOICRsdW4gPT09PT09PT09PT09PT09PSIKICBkb25lCmVsc2UKICBsb2cgIkVSUjogSW5wdXQgcGFyYW1ldGVyIGNvdW50IG5vdCBlcXVhbCIKICBleGl0IDEKZmkKCmluc3RhbGxQYWNrYWdlcwoKc2FwdHVuZSBzb2x1dGlvbiBhcHBseSBIQU5BCnNhcHR1bmUgZGFlbW9uIHN0YXJ0CgplbmFibGVTd2FwCgpleGl0Cg=="
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "SUSE",
                        "offer": "[variables('imageOffer')]",
                        "sku": "[variables('imageSku')]",
                        "version": "latest"
                    },
                    "osDisk": {
                        "name": "[concat(parameters('hVMName'), '-osdisk')]",
                        "caching": "[variables('hOSDiskCaching')]",
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "[variables('hOSDiskStorageType')]"
                        }
                    },
                    "dataDisks": "[variables('sizes')[parameters('size')].hana.disks]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('hNICName'))]"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('hVMName'), '/', 'CustomScript')]",
            "apiVersion": "2018-06-01",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('hVMName'))]"
            ],
            "tags": {
                "provider": "[toUpper(parameters('_SUSETags').provider)]"
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [],
                    "commandToExecute": "[concat('while [ ! -f /var/lib/cloud/instance/user-data.txt ]; do sleep 1; done;sleep 10;cat /var/lib/cloud/instance/user-data.txt | sh -s -- ', variables('sizes')[parameters('size')].hana.scriptArguments)]"
                }
            }
        }
    ]
}
